name: CI/CD Main Branch

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

# Prevent concurrent workflows on the same branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Backend Build and Test
    backend:
        name: Backend Build & Test
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: ./be

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
                  cache-dependency-path: be/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Lint code
              run: npm run lint --if-present
              continue-on-error: true

            - name: Build backend
              run: npm run build --if-present

            - name: Run tests
              run: npm test --if-present

            - name: Upload backend build artifacts
              if: matrix.node-version == '20.x'
              uses: actions/upload-artifact@v4
              with:
                  name: backend-build
                  path: |
                      be/dist
                      be/package.json
                      be/package-lock.json
                  retention-days: 30

    # Frontend Build and Test
    frontend:
        name: Frontend Build & Test
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: ./fe

        strategy:
            matrix:
                node-version: [18.x, 20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"
                  cache-dependency-path: fe/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Lint code
              run: npm run lint --if-present
              continue-on-error: true

            - name: Type check
              run: npm run type-check --if-present
              continue-on-error: true

            - name: Build frontend
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Run tests
              run: npm test --if-present

            - name: Upload frontend build artifacts
              if: matrix.node-version == '20.x'
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-build
                  path: |
                      fe/.next
                      fe/public
                      fe/package.json
                      fe/package-lock.json
                  retention-days: 30

    # Security Scanning
    security:
        name: Security Audit
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"

            - name: Backend Security Audit
              working-directory: ./be
              run: |
                  npm audit --audit-level=moderate || true

            - name: Frontend Security Audit
              working-directory: ./fe
              run: |
                  npm audit --audit-level=moderate || true

    # Code Quality Check
    code-quality:
        name: Code Quality
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Shallow clones should be disabled for better analysis

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"

            - name: Check for TODO/FIXME comments
              run: |
                  echo "Checking for TODO/FIXME comments..."
                  grep -r "TODO\|FIXME" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . || echo "No TODO/FIXME found"

    # Create Release Artifacts
    create-release-artifacts:
        name: Create Release Artifacts
        needs: [backend, frontend]
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download backend artifacts
              uses: actions/download-artifact@v4
              with:
                  name: backend-build
                  path: ./artifacts/backend

            - name: Download frontend artifacts
              uses: actions/download-artifact@v4
              with:
                  name: frontend-build
                  path: ./artifacts/frontend

            - name: Create deployment package
              run: |
                  cd artifacts
                  tar -czf ../nawa-napam-${{ github.sha }}.tar.gz backend frontend
                  cd ..
                  ls -lh nawa-napam-${{ github.sha }}.tar.gz

            - name: Upload deployment package
              uses: actions/upload-artifact@v4
              with:
                  name: deployment-package-${{ github.sha }}
                  path: nawa-napam-${{ github.sha }}.tar.gz
                  retention-days: 90

            - name: Generate build summary
              run: |
                  echo "## Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Build Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
                  echo "- **Artifact**: deployment-package-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

    # Final Status Check
    ci-success:
        name: CI Success
        needs: [backend, frontend, security, code-quality]
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: Check build status
              run: |
                  if [[ "${{ needs.backend.result }}" == "success" ]] && \
                     [[ "${{ needs.frontend.result }}" == "success" ]] && \
                     [[ "${{ needs.security.result }}" == "success" ]] && \
                     [[ "${{ needs.code-quality.result }}" == "success" ]]; then
                    echo "✅ All CI checks passed!"
                    exit 0
                  else
                    echo "❌ Some CI checks failed!"
                    echo "Backend: ${{ needs.backend.result }}"
                    echo "Frontend: ${{ needs.frontend.result }}"
                    echo "Security: ${{ needs.security.result }}"
                    echo "Code Quality: ${{ needs.code-quality.result }}"
                    exit 1
                  fi
